#!/usr/bin/env node

const path = require("path")
const pm2 = require("pm2")
const package = require(path.join(process.cwd(), "package.json"))

process.env.NODE_ENV = process.env.NODE_ENV || "production"

if (process.env.NODE_ENV === "production") {
  require = require("@std/esm")(module, {
    esm: "cjs"
  })
  require("./build.js")
}
else {
  pm2.connect(function(err) {
    if (err) {
      console.error(err)
      process.exit(2)
    }

    console.log("webpack is watching")

    pm2.start({
      name: package.name + "/build",
      script: path.join(__dirname, "build.js"),
      node_args: "-r " + path.join(__dirname, "node_modules/@std/esm"),
    }, (err, proc) => {
      pm2.disconnect()
      if(err) console.log(err)
    })
  })

}
